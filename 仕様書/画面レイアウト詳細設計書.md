# 画面レイアウト詳細設計書

## 1. ドキュメント情報

### 1.1 ドキュメント概要
- **ドキュメント名**: 画面レイアウト詳細設計書
- **システム名**: 封口体アンドン#1,2
- **作成日**: 2025-12-08
- **バージョン**: 1.1

### 1.2 目的
Blazor Serverで実装する封口体アンドン画面のレイアウト仕様を定義する。

---

## 2. 画面全体構成

### 2.1 画面構成概要
画面は以下の6つの主要エリアで構成される:

1. ヘッダーエリア
2. ステータス凡例エリア
3. 装置ステータステーブルエリア
4. A室重カウンタエリア
5. メンテナンスカウンタエリア
6. 熱カメヘッドステータスエリア

### 2.2 画面レイアウト構造

```
+------------------------------------------------------------------+
|  [ヘッダーエリア]                        [ステータス凡例エリア]   |
+------------------------------------------------------------------+
|  [装置ステータステーブルエリア]                                    |
+------------------------------------------------------------------+
|  [A室重カウンタエリア]                   [熱カメヘッドステータス]  |
|  [メンテナンスカウンタエリア]                                      |
+------------------------------------------------------------------+
```

---

## 3. コンポーネント詳細設計

### 3.1 ヘッダーエリア

#### 3.1.1 配置
- 位置: 画面左上
- サイズ: 横幅約40%、高さ固定

#### 3.1.2 表示内容
- **タイトル**: 「姫路1号 封口体」
  - フォント: ゴシック体
  - サイズ: 大（32px程度）
  - 色: 黒
  - 配置: 左寄せ

- **日付表示**: 「日付」ラベル
  - フォント: ゴシック体
  - サイズ: 中（20px程度）
  - 色: 黒
  - 配置: タイトルの右側

#### 3.1.3 データバインディング
- タイトル: 固定文字列または設定ファイルから取得
- 日付: システム日時から取得（フォーマット: yyyy-MM-dd または yyyy年MM月dd日）

---

### 3.2 ステータス凡例エリア

#### 3.2.1 配置
- 位置: 画面右上（ヘッダーエリアの右側）
- サイズ: 横幅約60%、高さ固定

#### 3.2.2 表示内容
凡例を縦に並べて表示:

1. **重要**: 赤色・赤枠
2. **停止**: 赤色・白枠
3. **稼動**: 黒色・黒枠
4. **メンテアラーム**: 黄色・黄枠
5. **材料アラーム**: 青色・青枠

#### 3.2.3 凡例項目の構造
各凡例項目は以下の構成:
- テキスト部分（左側）
  - 例: "重要："
  - フォント: ゴシック体
  - サイズ: 中（18px程度）

- 色見本部分（右側）
  - 背景色と枠線色の組み合わせ
  - サイズ: 小さな四角形（50px × 20px程度）

#### 3.2.4 色仕様
| ステータス  | 背景色        | 枠線色        | 文字色        |
| ------ | ---------- | ---------- | ---------- |
| 重要     | #FF0000（赤） | #FF0000（赤） | #FF0000（赤） |
| 停止     | #FF0000（赤） | #FFFFFF（白） | #FF0000（赤） |
| 稼動     | #000000（黒） | #000000（黒） | #000000（黒） |
| メンテアラーム | #FFFF00（黄） | #FFFF00（黄） | #FFFF00（黄） |
| 材料アラーム | #0000FF（青） | #0000FF（青） | #0000FF（青） |

---

### 3.3 装置ステータステーブルエリア

#### 3.3.1 配置
- 位置: ヘッダーエリアの下、画面中央上部
- サイズ: 横幅80%程度、高さ可変（行数に応じる）

#### 3.3.2 テーブル構造
3列の構成:

| 列名 | 幅 | 内容 |
|------|-----|------|
| 装置名 | 15% | 装置の識別名 |
| 一斉度数 | 15% | 処理回数の数値 |
| 異常名・稼働名 | 70% | ステータスメッセージ表示エリア |

#### 3.3.3 表示する装置
以下の5つの装置を固定で表示:
1. FAW-A
2. FAW-B
3. FAW-CD
4. FAW-E
5. HMA

#### 3.3.4 データバインディング
- **装置名**: 固定文字列
- **一斉度数**: JSONデータから該当装置の処理回数を取得
- **異常名・稼働名**: JSONデータから該当装置のステータス情報を取得
  - 表示内容はステータスによって変わる
  - 背景色はステータスに応じて変更（3.2.4の色仕様に従う）

#### 3.3.5 スタイル仕様
- セルの枠線: 黒、1px
- ヘッダー行:
  - 背景色: ライトグレー（#D3D3D3）
  - 文字色: 黒
  - フォントサイズ: 中（18px程度）
- データ行:
  - 背景色: 白（通常時）、ステータスによって変動
  - 文字色: 黒（通常時）、ステータスによって変動
  - フォントサイズ: 中（18px程度）

---

### 3.4 A室重カウンタエリア

#### 3.4.1 配置
- 位置: 装置ステータステーブルの下、画面左側
- サイズ: 横幅30%程度、高さ固定

#### 3.4.2 表示内容
- **ラベル**: 「A室重：2D印字回数」
  - フォント: ゴシック体
  - サイズ: 中（18px程度）
  - 色: 黒
  - 背景色: 白

- **値**: 「1.5万ショット/回」形式
  - フォント: ゴシック体、太字
  - サイズ: 大（24px程度）
  - 色: 黒
  - 背景色: 緑（#00FF00または#90EE90）
  - 配置: 中央揃え

#### 3.4.3 データバインディング
- JSONデータから該当デバイス（A室重カウンタ）の値を取得
- 単位変換: 値を万単位に変換して表示（例: 15000 → 1.5万）
- フォーマット: "{値}万ショット/回"

#### 3.4.4 レイアウト
2行構成:
- 1行目: ラベル（左寄せ、白背景）
- 2行目: 値（中央寄せ、緑背景）

---

### 3.5 メンテナンスカウンタエリア

#### 3.5.1 配置
- 位置: A室重カウンタエリアの下、画面左側
- サイズ: 横幅30%程度、高さ可変

#### 3.5.2 テーブル構造
3列の構成:

| 列名 | 幅 | 内容 |
|------|-----|------|
| 項目名 | 30% | メンテナンス項目名 |
| 貴延カメ1/正延カメ1 | 35% | カメ1の値 |
| 正延カメ1 | 35% | カメ2の値 |

#### 3.5.3 表示項目
JSONから読み込んだ値で表示で以下の3項目を表示:



1. **バンチメッシ**
   - 列2: 貴延カメ1（6万ショット/回）
   - 列3: 正延カメ1（6万ショット/回）

2. **バネ交換**
   - 列2: 30万ショット/回
   - 列3: 100万ショット/回

3. **バンチ補整**
   - 列2: 100万ショット/回
   - 列3: 100万ショット/回

#### 3.5.4 データバインディング
- JSONデータから該当デバイスの各メンテナンスカウンタ値を取得
- 単位変換: 値を万単位に変換して表示
- フォーマット: "{値}万ショット/回"

#### 3.5.5 スタイル仕様
- セルの枠線: 黒、1px
- ヘッダー行: 背景色ライトグレー、文字色黒
- データ行: 背景色白、文字色黒
- フォントサイズ: 中（16px程度）

---

### 3.6 熱カメヘッドステータスエリア

#### 3.6.1 配置
- 位置: 装置ステータステーブルの下、画面右側
- サイズ: 横幅40%程度、高さ可変

#### 3.6.2 テーブル構造
3列の構成:

| 列名 | 幅 | 内容 |
|------|-----|------|
| ヘッド番号 | 33% | ヘッド1～5 |
| 熱カメ1 | 33% | ステータス表示 |
| 熱カメ2 | 33% | ステータス表示 |

#### 3.6.3 表示内容
- **ヘッダー行**: 空白セル、「熱カメ1」、「熱カメ2」
- **データ行**: 「ヘッド1」～「ヘッド5」の5行

#### 3.6.4 ステータス表示仕様
各セルは以下のステータスで表示:
- **稼働中**: 緑色背景（#00FF00または#90EE90）
- **停止中**: 白色背景（#FFFFFF）

#### 3.6.5 データバインディング
- JSONデータから各熱カメヘッドのステータス（ON/OFF, 0/1）を取得
- ステータスに応じてセルの背景色を変更
  - 稼働（1, ON, true）: 緑色
  - 停止（0, OFF, false）: 白色

#### 3.6.6 スタイル仕様
- セルの枠線: 黒、1px
- ヘッダー行: 背景色ライトグレー、文字色黒
- データ行:
  - 背景色: ステータスに応じて緑または白
  - 文字色: 黒
  - フォントサイズ: 中（16px程度）
- セルのパディング: 上下左右10px程度

---

## 4. レスポンシブ対応

### 4.1 基本方針
- 大型ディスプレイでの表示を想定
- 固定レイアウトを採用
- 最小解像度: 1920×1080px

### 4.2 レイアウト配置
- グリッドシステムを使用
- 2列レイアウト:
  - 左列: A室重カウンタ、メンテナンスカウンタ（30%）
  - 右列: 熱カメヘッドステータス（40%）
  - 中央余白（30%）

---

## 5. データ更新仕様

### 5.1 更新頻度
- 全エリアを1秒ごとに更新
- タイマーベースの自動更新を実装

### 5.2 更新対象
以下のエリアがリアルタイム更新対象:
- 日付表示
- 装置ステータステーブル（一斉度数、異常名・稼働名）
- A室重カウンタの値
- メンテナンスカウンタの値
- 熱カメヘッドステータス

### 5.3 更新方式
- Blazor ServerのStateHasChangedを使用
- JSONファイル読み込み → データパース → UI更新のサイクル

---

## 6. エラー表示仕様

### 6.1 通信異常表示
JSONファイル読み込みに60秒以上失敗した場合:
- 表示位置: 画面中央にオーバーレイ表示
- 背景色: 半透明の赤（#FF0000, opacity: 0.8）
- テキスト: 「通信異常」
- フォントサイズ: 特大（48px程度）
- 文字色: 白
- 点滅: あり（1秒間隔）

### 6.2 エラー解除
- JSONファイル読み込みが成功したら即座に非表示

---

## 7. Blazorコンポーネント構成案

### 7.1 コンポーネント階層

```
MainLayout.razor
├── HeaderComponent.razor（ヘッダーエリア）
├── StatusLegendComponent.razor（ステータス凡例）
├── DeviceStatusTableComponent.razor（装置ステータステーブル）
├── LeftPanelComponent.razor
│   ├── ARoomCounterComponent.razor（A室重カウンタ）
│   └── MaintenanceCounterComponent.razor（メンテナンスカウンタ）
├── HeatCameraStatusComponent.razor（熱カメヘッドステータス）
└── ErrorOverlayComponent.razor（エラー表示）
```

### 7.2 共通サービス
- **JsonDataService**: JSONファイル読み込み、パース処理
- **TimerService**: 1秒ごとの更新タイマー管理
- **ErrorMonitorService**: 通信異常監視（60秒チェック）

---

## 8. スタイル定義

### 8.1 共通スタイル
- フォントファミリー: "メイリオ", "Meiryo", "MS Gothic", sans-serif
- 基本背景色: 白（#FFFFFF）
- 基本文字色: 黒（#000000）

### 8.2 色定義（CSS変数）
```
--color-important: #FF0000;     /* 重要 */
--color-stop: #FF0000;          /* 停止 */
--color-active: #000000;        /* 稼動 */
--color-shima-alarm: #FFFF00;   /* メンテアラーム */
--color-material-alarm: #0000FF; /* 材料アラーム */
--color-active-bg: #90EE90;     /* 稼働中背景（緑） */
--color-inactive-bg: #FFFFFF;   /* 停止中背景（白） */
--color-border: #000000;        /* 枠線 */
--color-header-bg: #D3D3D3;     /* ヘッダー背景 */
```

### 8.3 テーブル共通スタイル
- 枠線: 1px solid var(--color-border)
- セル内パディング: 8px
- テーブル幅: 100%
- テーブル境界線結合: collapse

---

## 9. データマッピング仕様

### 9.1 JSONデータとUI要素のマッピング

#### 9.1.1 装置ステータステーブル
Sample

| UI要素         | JSONデバイス番号 | 備考               |
| ------------ | ---------- | ---------------- |
| FAW-A 一斉度数   | D100       | word型            |
| FAW-A ステータス  | M0         | bit型、複数bitの組み合わせ |
| FAW-B 一斉度数   | D101       | word型            |
| FAW-B ステータス  | M10        | bit型             |
| FAW-CD 一斉度数  | D102       | word型            |
| FAW-CD ステータス | M20        | bit型             |
| FAW-E 一斉度数   | D103       | word型            |
| FAW-E ステータス  | M30        | bit型             |
| HMA 一斉度数     | D104       | word型            |
| HMA ステータス    | M40        | bit型             |

#### 9.1.2 A室重カウンタ
Sample

| UI要素     | JSONデバイス番号 | 備考             |
| -------- | ---------- | -------------- |
| A室重カウンタ値 | D200       | word型またはdword型 |

#### 9.1.3 メンテナンスカウンタ
Sample

| UI要素         | JSONデバイス番号 | 備考     |
| ------------ | ---------- | ------ |
| バンチメッシ 貴延カメ1 | D300       | word型  |
| バンチメッシ 正延カメ1 | D301       | word型  |
| バネ交換 値1      | D302       | dword型 |
| バネ交換 値2      | D303       | dword型 |
| バンチ補整 値1     | D304       | dword型 |
| バンチ補整 値2     | D305       | dword型 |

#### 9.1.4 熱カメヘッドステータス
Sample

| UI要素      | JSONデバイス番号 | 備考             |
| --------- | ---------- | -------------- |
| 熱カメ1 ヘッド1 | M100       | bit型、0=停止、1=稼働 |
| 熱カメ1 ヘッド2 | M101       | bit型           |
| 熱カメ1 ヘッド3 | M102       | bit型           |
| 熱カメ1 ヘッド4 | M103       | bit型           |
| 熱カメ1 ヘッド5 | M104       | bit型           |
| 熱カメ2 ヘッド1 | M110       | bit型           |
| 熱カメ2 ヘッド2 | M111       | bit型           |
| 熱カメ2 ヘッド3 | M112       | bit型           |
| 熱カメ2 ヘッド4 | M113       | bit型           |
| 熱カメ2 ヘッド5 | M114       | bit型           |

注: 実際のデバイス番号は要件定義書のJSONデータ構造に従って調整が必要

---

## 10. 状態管理・インスタンス設計

### 10.1 インスタンス管理の基本方針
各画面エリアのデータはBlazorコンポーネントのインスタンスとして管理し、JSONデータの更新に応じてリアクティブに状態を変更する。

### 10.2 装置ステータステーブルのインスタンス管理

#### 10.2.1 管理単位
- **管理単位**: 行単位（装置単位）でインスタンスを作成
- **インスタンス数**: 5個（FAW-A, FAW-B, FAW-CD, FAW-E, HMA）

#### 10.2.2 インスタンスが管理するプロパティ
各装置行インスタンスは以下のプロパティを持つ:

| プロパティ名 | 型 | 説明 |
|------------|-----|------|
| DeviceName | string | 装置名（FAW-A等） |
| ProductionCount | int | 生産数（一斉度数） |
| StatusMessage | string | 異常名・待機名のメッセージ |
| StatusType | enum | ステータス種別（重要/停止/稼動/メンテアラーム/材料アラーム） |
| BackgroundColor | string | 背景色（ステータスに応じて変動） |
| TextColor | string | 文字色（ステータスに応じて変動） |
| BorderColor | string | 枠線色（ステータスに応じて変動） |

#### 10.2.3 クラス設計例
```
public class DeviceStatusRowInstance
{
    public string DeviceName { get; set; }
    public int ProductionCount { get; set; }
    public string StatusMessage { get; set; }
    public StatusType StatusType { get; set; }
    public string BackgroundColor { get; set; }
    public string TextColor { get; set; }
    public string BorderColor { get; set; }

    public void UpdateFromJson(JsonDeviceData data)
    {
        // JSONデータから状態を更新
    }
}

public enum StatusType
{
    Important,      // 重要
    Stop,           // 停止
    Active,         // 稼動
    ShimaAlarm,     // メンテアラーム
    MaterialAlarm   // 材料アラーム
}
```

---

### 10.3 A室重カウンタのインスタンス管理

#### 10.3.1 管理単位
- **管理単位**: ショット回数の値のみ
- **インスタンス数**: 1個

#### 10.3.2 インスタンスが管理するプロパティ
| プロパティ名 | 型 | 説明 |
|------------|-----|------|
| ShotCount | int | ショット回数（生の値） |
| DisplayValue | string | 表示用フォーマット済み文字列（例: "1.5万ショット/回"） |

#### 10.3.3 クラス設計例
```
public class ARoomCounterInstance
{
    public int ShotCount { get; set; }
    public string DisplayValue => FormatShotCount(ShotCount);

    private string FormatShotCount(int count)
    {
        double manValue = count / 10000.0;
        return $"{manValue:F1}万ショット/回";
    }

    public void UpdateFromJson(int value)
    {
        ShotCount = value;
    }
}
```

---

### 10.4 メンテナンスカウンタのインスタンス管理

#### 10.4.1 管理単位
- **管理単位**: 負極カシメ1、正極カシメ1の各項目を個別管理
- **インスタンス数**: 6個
  - 負極カシメ1: 3個（パンチ、ばね交換、パンチ確認）
  - 正極カシメ1: 3個（パンチ、ばね交換、パンチ確認）

#### 10.4.2 インスタンスが管理するプロパティ
各メンテナンスカウンタインスタンスは以下のプロパティを持つ:

| プロパティ名 | 型 | 説明 |
|------------|-----|------|
| ItemName | string | 項目名（パンチ/ばね交換/パンチ確認） |
| CameraType | string | カメ種別（負極カシメ1/正極カシメ1） |
| ShotCount | int | ショット回数（生の値） |
| DisplayValue | string | 表示用フォーマット済み文字列（例: "6万ショット/回"） |

#### 10.4.3 クラス設計例
```
public class MaintenanceCounterInstance
{
    public string ItemName { get; set; }          // "パンチ"/"ばね交換"/"パンチ確認"
    public string CameraType { get; set; }        // "負極カシメ1"/"正極カシメ1"
    public int ShotCount { get; set; }
    public string DisplayValue => FormatShotCount(ShotCount);

    private string FormatShotCount(int count)
    {
        double manValue = count / 10000.0;
        return $"{manValue:F0}万ショット/回";
    }

    public void UpdateFromJson(int value)
    {
        ShotCount = value;
    }
}
```

#### 10.4.4 インスタンスリスト構造
```
List<MaintenanceCounterInstance> instances = new()
{
    // 負極カシメ1
    new() { ItemName = "パンチ", CameraType = "負極カシメ1" },
    new() { ItemName = "ばね交換", CameraType = "負極カシメ1" },
    new() { ItemName = "パンチ確認", CameraType = "負極カシメ1" },

    // 正極カシメ1
    new() { ItemName = "パンチ", CameraType = "正極カシメ1" },
    new() { ItemName = "ばね交換", CameraType = "正極カシメ1" },
    new() { ItemName = "パンチ確認", CameraType = "正極カシメ1" }
};
```

---

### 10.5 熱カメヘッドステータスのインスタンス管理

#### 10.5.1 管理単位
- **管理単位**: 熱カシメ1、熱カシメ2を別々に管理
- **インスタンス数**: 2個（熱カシメ1用、熱カシメ2用）

#### 10.5.2 インスタンスが管理するプロパティ
各熱カメインスタンスは以下のプロパティを持つ:

| プロパティ名 | 型 | 説明 |
|------------|-----|------|
| CameraName | string | カメ名（熱カシメ1/熱カシメ2） |
| Head1Status | bool | ヘッド1のステータス（true=稼働, false=停止） |
| Head2Status | bool | ヘッド2のステータス |
| Head3Status | bool | ヘッド3のステータス |
| Head4Status | bool | ヘッド4のステータス |
| Head5Status | bool | ヘッド5のステータス |

#### 10.5.3 クラス設計例
```
public class HeatCameraInstance
{
    public string CameraName { get; set; }        // "熱カシメ1"/"熱カシメ2"
    public bool Head1Status { get; set; }
    public bool Head2Status { get; set; }
    public bool Head3Status { get; set; }
    public bool Head4Status { get; set; }
    public bool Head5Status { get; set; }

    public string GetHeadBackgroundColor(int headNumber)
    {
        bool status = headNumber switch
        {
            1 => Head1Status,
            2 => Head2Status,
            3 => Head3Status,
            4 => Head4Status,
            5 => Head5Status,
            _ => false
        };

        return status ? "#90EE90" : "#FFFFFF";  // 緑 or 白
    }

    public void UpdateFromJson(bool[] headStatuses)
    {
        if (headStatuses.Length >= 5)
        {
            Head1Status = headStatuses[0];
            Head2Status = headStatuses[1];
            Head3Status = headStatuses[2];
            Head4Status = headStatuses[3];
            Head5Status = headStatuses[4];
        }
    }
}
```

#### 10.5.4 インスタンスリスト構造
```
List<HeatCameraInstance> heatCameras = new()
{
    new() { CameraName = "熱カシメ1" },
    new() { CameraName = "熱カシメ2" }
};
```

---

### 10.6 インスタンス更新フロー

#### 10.6.1 全体の更新フロー
1. タイマーイベント（1秒ごと）
2. JSONファイル読み込み
3. JSONデータをパース
4. 各インスタンスの`UpdateFromJson`メソッドを呼び出し
5. `StateHasChanged()`を呼び出してUI更新

#### 10.6.2 更新シーケンス図
```
Timer (1秒) → JsonDataService.LoadAsync()
                ↓
              JSONパース
                ↓
        各インスタンスの更新
                ↓
    ┌─────────┬─────────┬─────────┬─────────┐
    ↓         ↓         ↓         ↓         ↓
  装置行×5   A室重×1  メンテ×6  熱カメ×2  エラー監視
    ↓         ↓         ↓         ↓         ↓
              StateHasChanged()
                ↓
              UI再描画
```

---

## 11. パフォーマンス要件

### 11.1 描画パフォーマンス
- 初回描画: 2秒以内
- 更新描画: 100ms以内
- メモリ使用量: 500MB以下（24時間稼働時）

### 11.2 データ処理
- JSONファイル読み込み: 100ms以内
- データパース: 50ms以内
- UI更新: 50ms以内

---

## 12. 補足事項

### 12.1 実装上の注意点
- 丸番号付きのマーカー（①～⑩）は実装しない
- 大型ディスプレイでの視認性を最優先
- フォントサイズは現場での確認後、調整可能とする
- 色の明度・彩度は現場環境に応じて微調整可能とする

### 12.2 今後の拡張性
- 装置追加に対応できるよう、装置リストは設定ファイル化を検討
- 表示言語の切り替え機能（将来的に検討）
- ログ記録機能の追加（要件定義書NFR-004）

---

## 13. 承認

| 役割 | 氏名 | 承認日 | 署名 |
|------|------|--------|------|
| 作成者 |      | 2025-12-08 |      |
| 確認者 |      |        |      |
| 承認者 |      |        |      |

---

## 14. 変更履歴

| バージョン | 日付 | 変更者 | 変更内容 |
|------------|------|--------|----------|
| 1.0 | 2025-12-08 | - | 初版作成 |
| 1.1 | 2025-12-08 | - | 状態管理・インスタンス設計セクション追加 |
